//= require jquery3
//= require popper
//= require bootstrap-sprockets
//= require rails-ujs
//= require turbolinks
//= require_tree .
import "@hotwired/turbo-rails"
import "@hotwired/stimulus"
import "controllers"
import * as bootstrap from "bootstrap"
import * as google from "googlemaps"

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
window.HanayamaReminder = {
  map: null,
  markers: []
};

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂá¶ÁêÜ
document.addEventListener('turbolinks:load', function() {
  initializeApp();
});

// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
function initializeApp() {
  initNotificationPopup();
  initImagePreview();
  initLikeButtons();
  initFormValidation();
  initTooltips();
  initScrollAnimations();
  initMobileMenu();
}

// ÈÄöÁü•„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
function initNotificationPopup() {
  const popup = document.querySelector('.notification-popup');
  if (popup) {
    setTimeout(() => {
      popup.classList.add('show');
    }, 1000);
    
    // Ëá™Âãï„ÅßÈñâ„Åò„Çã
    setTimeout(() => {
      popup.classList.remove('show');
    }, 8000);
  }
}

// ÁîªÂÉè„Éó„É¨„Éì„É•„Éº
function initImagePreview() {
  const imageInputs = document.querySelectorAll('input[type="file"][accept*="image"]');
  
  imageInputs.forEach(input => {
    input.addEventListener('change', function(e) {
      const file = e.target.files[0];
      const previewContainer = document.getElementById('image-preview');
      
      if (file && previewContainer) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          previewContainer.innerHTML = `
            <div class="position-relative d-inline-block">
              <img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px; max-width: 300px;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="clearImagePreview()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          `;
          previewContainer.classList.remove('d-none');
        };
        
        reader.readAsDataURL(file);
      }
    });
  });
}

// ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Çí„ÇØ„É™„Ç¢
function clearImagePreview() {
  const previewContainer = document.getElementById('image-preview');
  const fileInput = document.querySelector('input[type="file"][accept*="image"]');
  
  if (previewContainer) {
    previewContainer.innerHTML = '';
    previewContainer.classList.add('d-none');
  }
  
  if (fileInput) {
    fileInput.value = '';
  }
}

// „ÅÑ„ÅÑ„Å≠„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
function initLikeButtons() {
  const likeButtons = document.querySelectorAll('.like-button');
  
  likeButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (this.dataset.processing === 'true') return;
      
      this.dataset.processing = 'true';
      const icon = this.querySelector('i');
      const countElement = this.querySelector('.like-count');
      
      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      icon.classList.add('animate__animated', 'animate__heartBeat');
      
      // Ajax „É™„ÇØ„Ç®„Çπ„Éà
      fetch(this.href, {
        method: this.dataset.method || 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // „ÅÑ„ÅÑ„Å≠Áä∂ÊÖã„ÇíÊõ¥Êñ∞
          if (data.liked) {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
            this.classList.add('liked');
          } else {
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
            this.classList.remove('liked');
          }
          
          // „Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
          if (countElement) {
            countElement.textContent = data.likes_count;
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showAlert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'danger');
      })
      .finally(() => {
        this.dataset.processing = 'false';
        setTimeout(() => {
          icon.classList.remove('animate__animated', 'animate__heartBeat');
        }, 1000);
      });
    });
  });
}

// „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
function initFormValidation() {
  const forms = document.querySelectorAll('.needs-validation');
  
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      form.classList.add('was-validated');
    });
  });
}

// „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÂàùÊúüÂåñ
function initTooltips() {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
}

// „Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
function initScrollAnimations() {
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('fade-in-up');
      }
    });
  }, observerOptions);
  
  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂØæË±°Ë¶ÅÁ¥†„ÇíÁõ£Ë¶ñ
  document.querySelectorAll('.card, .feature-icon').forEach(el => {
    observer.observe(el);
  });
}

// „É¢„Éê„Ç§„É´„É°„Éã„É•„Éº
function initMobileMenu() {
  const navbarToggler = document.querySelector('.navbar-toggler');
  const navbarCollapse = document.querySelector('.navbar-collapse');
  
  if (navbarToggler && navbarCollapse) {
    // „É°„Éã„É•„ÉºÂ§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.addEventListener('click', function(e) {
      if (!navbarCollapse.contains(e.target) && !navbarToggler.contains(e.target)) {
        const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
        if (bsCollapse && navbarCollapse.classList.contains('show')) {
          bsCollapse.hide();
        }
      }
    });
  }
}

// „Ç¢„É©„Éº„ÉàË°®Á§∫
function showAlert(message, type = 'info') {
  const alertContainer = document.getElementById('alert-container') || createAlertContainer();
  
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type} alert-dismissible fade show`;
  alertElement.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  alertContainer.appendChild(alertElement);
  
  // Ëá™Âãï„ÅßÂâäÈô§
  setTimeout(() => {
    if (alertElement.parentNode) {
      alertElement.remove();
    }
  }, 5000);
}

// „Ç¢„É©„Éº„Éà„Ç≥„É≥„ÉÜ„Éä‰ΩúÊàê
function createAlertContainer() {
  const container = document.createElement('div');
  container.id = 'alert-container';
  container.className = 'position-fixed top-0 end-0 p-3';
  container.style.zIndex = '1055';
  document.body.appendChild(container);
  return container;
}

// Âú∞Âõ≥ÂàùÊúüÂåñÔºàGoogle MapsÔºâ
function initMap() {
  const mapElement = document.getElementById('map');
  if (!mapElement) return;
  
  const center = { lat: 36.2048, lng: 138.2529 };
  
  HanayamaReminder.map = new google.maps.Map(mapElement, {
    zoom: 6,
    center: center,
    styles: [
      {
        featureType: 'all',
        elementType: 'geometry.fill',
        stylers: [{ color: '#f0f9ff' }]
      },
      {
        featureType: 'water',
        elementType: 'geometry',
        stylers: [{ color: '#a7c6ed' }]
      }
    ]
  });
  
  // „Éû„Éº„Ç´„Éº„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
  if (window.mapData) {
    addMarkersToMap(window.mapData);
  }
}

// „Éû„Éº„Ç´„Éº„ÇíÂú∞Âõ≥„Å´ËøΩÂä†
function addMarkersToMap(locations) {
  const bounds = new google.maps.LatLngBounds();
  
  locations.forEach(location => {
    if (location.lat && location.lng) {
      const marker = new google.maps.Marker({
        position: { lat: parseFloat(location.lat), lng: parseFloat(location.lng) },
        map: HanayamaReminder.map,
        title: location.name,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
              <circle cx="16" cy="16" r="12" fill="#22c55e" stroke="#fff" stroke-width="2"/>
              <text x="16" y="20" text-anchor="middle" fill="white" font-size="16">üå∏</text>
            </svg>
          `),
          scaledSize: new google.maps.Size(32, 32)
        }
      });
      
      const infoWindow = new google.maps.InfoWindow({
        content: createInfoWindowContent(location)
      });
      
      marker.addListener('click', () => {
        // ‰ªñ„ÅÆInfoWindow„ÇíÈñâ„Åò„Çã
        HanayamaReminder.markers.forEach(m => {
          if (m.infoWindow) m.infoWindow.close();
        });
        
        infoWindow.open(HanayamaReminder.map, marker);
      });
      
      HanayamaReminder.markers.push({ marker, infoWindow });
      bounds.extend(marker.getPosition());
    }
  });
  
  // Âú∞Âõ≥„ÅÆË°®Á§∫ÁØÑÂõ≤„ÇíË™øÊï¥
  if (HanayamaReminder.markers.length > 0) {
    HanayamaReminder.map.fitBounds(bounds);
    
    // „Ç∫„Éº„É†„ÅåËøë„Åô„Åé„ÇãÂ†¥Âêà„ÅØË™øÊï¥
    google.maps.event.addListenerOnce(HanayamaReminder.map, 'bounds_changed', () => {
      if (HanayamaReminder.map.getZoom() > 12) {
        HanayamaReminder.map.setZoom(12);
      }
    });
  }
}

// InfoWindow „ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ‰ΩúÊàê
function createInfoWindowContent(location) {
  return `
    <div style="padding: 10px; max-width: 250px; font-family: 'Helvetica Neue', Arial, sans-serif;">
      <h5 style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600;">${location.name}</h5>
      <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
        <strong>üå∏ Ëä±:</strong> ${location.flower}
      </p>
      <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
        <strong>üìç Èõ£ÊòìÂ∫¶:</strong> ${location.difficulty || 'Êú™Ë®≠ÂÆö'}
      </p>
      ${location.days_left ? `
        <p style="margin: 4px 0; color: #22c55e; font-size: 14px; font-weight: 600;">
          <strong>‚è∞ Ë¶ãÈ†É„Åæ„Åß:</strong> „ÅÇ„Å®${location.days_left}Êó•
        </p>
      ` : ''}
      <div style="margin-top: 12px;">
        <a href="/flower_mountains/${location.id}" 
           style="background: linear-gradient(135deg, #22c55e, #16a34a); 
                  color: white; 
                  padding: 6px 12px; 
                  border-radius: 6px; 
                  text-decoration: none; 
                  font-size: 13px; 
                  font-weight: 500;">
          Ë©≥Á¥∞„ÇíË¶ã„Çã
        </a>
      </div>
    </div>
  `;
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
function showLoading(element) {
  if (element) {
    element.innerHTML = '<div class="text-center py-4"><div class="loading"></div></div>';
  }
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
function hideLoading(element, content) {
  if (element) {
    element.innerHTML = content;
  }
}

// „Çπ„É†„Éº„Çπ„Çπ„ÇØ„É≠„Éº„É´
function smoothScrollTo(target) {
  const element = document.querySelector(target);
  if (element) {
    element.scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
}

// ÁîªÂÉèÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
function initLazyLoading() {
  const images = document.querySelectorAll('img[data-src]');
  
  const imageObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        imageObserver.unobserve(img);
      }
    });
  });
  
  images.forEach(img => imageObserver.observe(img));
}

// „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÁ¢∫Ë™ç
function initBeforeUnload() {
  const forms = document.querySelectorAll('form');
  let formChanged = false;
  
  forms.forEach(form => {
    form.addEventListener('input', () => {
      formChanged = true;
    });
    
    form.addEventListener('submit', () => {
      formChanged = false;
    });
  });
  
  window.addEventListener('beforeunload', (e) => {
    if (formChanged) {
      e.preventDefault();
      e.returnValue = '';
    }
  });
}

// ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜ
document.addEventListener('DOMContentLoaded', function() {
  initLazyLoading();
  initBeforeUnload();
});