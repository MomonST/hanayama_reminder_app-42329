<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>èŠ±å±±ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ - è¦‹é ƒã®èŠ±ã‚’è¦‹é€ƒã•ãªã„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="ã‚ãªãŸã®è¡ŒããŸã„ã‚¨ãƒªã‚¢ã®é«˜å±±æ¤ç‰©ã®é–‹èŠ±æ™‚æœŸã‚’äº‹å‰ã«ãŠçŸ¥ã‚‰ã›ã€‚å¿™ã—ã„æ—¥å¸¸ã§ã‚‚ã€æœ€é«˜ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å±±ã®èŠ±ã«å‡ºä¼šãˆã¾ã™ã€‚">
    <meta name="keywords" content="èŠ±,å±±,ç™»å±±,é«˜å±±æ¤ç‰©,é–‹èŠ±,é€šçŸ¥,ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼">
    
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¸</text></svg>">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Stylesheets -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    
    <!-- JavaScript -->
    <%= javascript_importmap_tags %>

    <!-- Google Maps API -->
    <% if content_for?(:use_google_maps) %>
      // mapDataãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§å®šç¾© (mapDataã¯ãƒ“ãƒ¥ãƒ¼ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æ)
      <script>
      window.mapData = <%= raw @map_data.to_json if defined?(@map_data) && @map_data.present? %>;
      </script>
      <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap&libraries=places" async defer>
      </script>
    <% end %>
    
  </head>

  <body class="gradient-bg">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <%= render 'shared/header' %>
    
    <!-- é€šçŸ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‰ã®ã¿ï¼‰ -->
    <% unless user_signed_in? %>
      <%= render 'shared/notification_popup' %>
    <% end %>
    
    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
    
    <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <% if notice %>
      <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <%= notice %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= alert %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container-fluid px-3 px-md-4 py-4">
      <%= yield %>
    </main>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <%= render 'shared/footer' %>
    
    <!-- ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
    <button id="page-top" class="btn btn-success position-fixed bottom-0 end-0 m-4 rounded-circle d-none" style="width: 50px; height: 50px; z-index: 1000;" onclick="smoothScrollTo('body')">
      <i class="bi bi-arrow-up"></i>
    </button>
    
    <script>
      // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      window.addEventListener('scroll', function() {
        const pageTop = document.getElementById('page-top');
        if (pageTop) { 
          if (window.scrollY > 300) {
            pageTop.classList.remove('d-none');
          } else {
            pageTop.classList.add('d-none');
          }
        }
      });

      // showAlert, createAlertContainer ã¯ application.js ã‹ã‚‰ç§»å‹•ã›ãšã€application.jsãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã“ã¨ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
      // copyShareUrl ã¯ app/views/posts/show.html.erb ãªã©ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã§ã€ã“ã“ã§ã¯å®šç¾©ã—ãªã„
      // ã‚ã‚‹ã„ã¯ã€application.jsã‹ã‚‰exportã—ã¦åˆ©ç”¨ã™ã‚‹
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªinitMapé–¢æ•° (Google Maps APIã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨)
      // HanayamaReminder.map ãŒå¿…è¦ã§ã‚ã‚Œã°ã€initMapã®å¤–ã§å®šç¾©ã—ã¦ãŠã
      window.HanayamaReminder = window.HanayamaReminder || {};
      
      // InfoWindow ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ (initMapã¨addMarkersToMapã®å‰ã«å®šç¾©ãŒå¿…è¦)
      function createInfoWindowContent(location) {
        return `
          <div style="padding: 10px; max-width: 250px; font-family: 'Helvetica Neue', Arial, sans-serif;">
            <h5 style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600;">${location.name}</h5>
            <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
              <strong>ğŸŒ¸ èŠ±:</strong> ${location.flower}
            </p>
            <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
              <strong>ğŸ“ é›£æ˜“åº¦:</strong> ${location.difficulty || 'æœªè¨­å®š'}
            </p>
            ${location.days_left ? `
              <p style="margin: 4px 0; color: #22c55e; font-size: 14px; font-weight: 600;">
                <strong>â° è¦‹é ƒã¾ã§:</strong> ã‚ã¨${location.days_left}æ—¥
              </p>
            ` : ''}
            <div style="margin-top: 12px;">
              <a href="/flower_mountains/${location.id}" 
                 style="background: linear-gradient(135deg, #22c55e, #16a34a); 
                        color: white; 
                        padding: 6px 12px; 
                        border-radius: 6px; 
                        text-decoration: none; 
                        font-size: 13px; 
                        font-weight: 500;">
                è©³ç´°ã‚’è¦‹ã‚‹
              </a>
            </div>
          </div>
        `;
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ  (initMapã®å‰ã«å®šç¾©ãŒå¿…è¦)
      function addMarkersToMap(locations) {
        const bounds = new google.maps.LatLngBounds();
        
        locations.forEach(location => {
          if (location.lat && location.lng) {
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(location.lat), lng: parseFloat(location.lng) },
              map: HanayamaReminder.map,
              title: location.name,
              icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                  <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="12" fill="#22c55e" stroke="#fff" stroke-width="2"/>
                    <text x="16" y="20" text-anchor="middle" fill="white" font-size="16">ğŸŒ¸</text>
                  </svg>
                `),
                scaledSize: new google.maps.Size(32, 32)
              }
            });
            
            const infoWindow = new google.maps.InfoWindow({
              content: createInfoWindowContent(location)
            });
            
            marker.addListener('click', () => {
              // ä»–ã®InfoWindowã‚’é–‰ã˜ã‚‹
              HanayamaReminder.markers.forEach(m => {
                if (m.infoWindow) m.infoWindow.close();
              });
              
              infoWindow.open(HanayamaReminder.map, marker);
            });
            
            HanayamaReminder.markers.push({ marker, infoWindow });
            bounds.extend(marker.getPosition());
          }
        });
        
        if (HanayamaReminder.markers.length > 0) {
          HanayamaReminder.map.fitBounds(bounds);
          
          google.maps.event.addListenerOnce(HanayamaReminder.map, 'bounds_changed', () => {
            if (HanayamaReminder.map.getZoom() > 12) {
              HanayamaReminder.map.setZoom(12);
            }
          });
        }
      }

      // åœ°å›³åˆæœŸåŒ–ï¼ˆGoogle Maps APIã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
      window.initMap = function() {
        const mapElement = document.getElementById('map');
        if (!mapElement) return; // mapè¦ç´ ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        
        const center = { lat: 36.2048, lng: 138.2529 };
        
        HanayamaReminder.map = new google.maps.Map(mapElement, {
          zoom: 6,
          center: center,
          styles: [
            {
              featureType: 'all',
              elementType: 'geometry.fill',
              stylers: [{ color: '#f0f9ff' }]
            },
            {
              featureType: 'water',
              elementType: 'geometry',
              stylers: [{ color: '#a7c6ed' }]
            }
          ]
        });
        
        // mapDataãŒã‚ã‚‹å ´åˆã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        if (window.mapData) {
          addMarkersToMap(window.mapData);
        }
      };
    </script>
  </body>
</html>