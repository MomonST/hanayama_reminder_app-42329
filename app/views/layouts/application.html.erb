<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>èŠ±å±±ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ - è¦‹é ƒã®èŠ±ã‚’è¦‹é€ƒã•ãªã„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="ã‚ãªãŸã®è¡ŒããŸã„ã‚¨ãƒªã‚¢ã®é«˜å±±æ¤ç‰©ã®é–‹èŠ±æ™‚æœŸã‚’äº‹å‰ã«ãŠçŸ¥ã‚‰ã›ã€‚å¿™ã—ã„æ—¥å¸¸ã§ã‚‚ã€æœ€é«˜ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å±±ã®èŠ±ã«å‡ºä¼šãˆã¾ã™ã€‚">
    <meta name="keywords" content="èŠ±,å±±,ç™»å±±,é«˜å±±æ¤ç‰©,é–‹èŠ±,é€šçŸ¥,ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼">
    
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¸</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    
    <%= javascript_importmap_tags %>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eOzrKbFN/LA" crossorigin="anonymous"></script>
    
    <% if content_for?(:use_Maps) %>
      <script>
        // @map_data ãŒå®šç¾©ã•ã‚Œã¦ã„ã¦ã€ã‹ã¤ç©ºã§ãªã„å ´åˆã®ã¿ window.mapData ã‚’è¨­å®šã™ã‚‹
        <% if defined?(@map_data) && @map_data.present? %>
          window.mapData = <%= raw @map_data.to_json %>;
        <% else %>
          window.mapData = []; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’è¨­å®šã™ã‚‹
        <% end %>
      </script>
      <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['Maps_API_KEY'] %>&callback=initMap&libraries=places" async defer>
      </script>
    <% end %>
    
  </head>

  <body class="min-vh-100 d-flex flex-column gradient-bg">
    <% unless user_signed_in? %>
      <%= render 'shared/notification_popup' %>
    <% end %>
    
    <%= render 'shared/login_prompt_modal' %>
    
    <header class="bg-white bg-opacity-90 shadow-sm border-bottom border-green-100">
      <div class="container-fluid px-4 px-sm-6 px-lg-8 mx-auto" style="max-width: 1280px;">
        <div class="d-flex justify-content-between align-items-center" style="height: 64px;">
          <div class="d-flex align-items-center me-2">
            <i class="bi bi-mountain fs-3 text-success"></i>
            <h1 class="fs-4 fw-bold ms-2 text-gradient">
              èŠ±å±±ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
            </h1>
          </div>
          <div class="d-flex align-items-center ms-3">
            <%= link_to new_post_path, class: "btn btn-sm btn-gradient-pink me-2", data: { bs_toggle: "modal", bs_target: "#loginPromptModal", user_logged_in: user_signed_in?.to_s } do %>
              <i class="bi bi-upload me-1"></i>
              ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŠ•ç¨¿
            <% end %>
            
            <% if user_signed_in? %>
              <%= link_to notifications_path, class: "btn btn-link text-dark p-1 me-1" do %>
                <i class="bi bi-bell fs-5"></i>
              <% end %>
              <%= link_to destroy_user_session_path, data: { turbo_method: :delete }, class: "btn btn-link text-dark p-1" do %>
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              <% end %>
            <% else %>
              <%= link_to new_user_session_path, class: "btn btn-link text-dark p-1 me-1", data: { bs_toggle: "modal", bs_target: "#loginPromptModal" } do %>
                ãƒ­ã‚°ã‚¤ãƒ³
              <% end %>
              <%= link_to new_user_registration_path, class: "btn btn-sm btn-success" do %>
                æ–°è¦ç™»éŒ²
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </header>

    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
    
    <% if notice %>
      <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <%= notice %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= alert %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% end %>
    
    <main class="container-fluid px-3 px-md-4 py-4 flex-grow-1" style="max-width: 1280px;">
      <%= yield %>
    </main>
    
    <footer class="bg-dark text-white py-4 mt-auto">
      <div class="container text-center">
        <p>&copy; 2024 èŠ±å±±ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼. All rights reserved.</p>
      </div>
    </footer>
    
    <button id="page-top" class="btn btn-success position-fixed bottom-0 end-0 m-4 rounded-circle d-none" style="width: 50px; height: 50px; z-index: 1000;" onclick="smoothScrollTo('body')">
      <i class="bi bi-arrow-up"></i>
    </button>
    
    <script>
      // smoothScrollTo é–¢æ•°ã¯ãã®ã¾ã¾æ®‹ã—ã¾ã™
      function smoothScrollTo(targetId) {
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
          window.scrollTo({
            top: targetElement.offsetTop,
            behavior: 'smooth'
          });
        }
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° HanayamaReminder ã®åˆæœŸåŒ–ã¯ä¸€åº¦ã ã‘
      window.HanayamaReminder = window.HanayamaReminder || { map: null, markers: [] };

      // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      window.addEventListener('scroll', function() {
        const pageTop = document.getElementById('page-top');
        if (pageTop) { 
          if (window.scrollY > 300) {
            pageTop.classList.remove('d-none');
          } else {
            pageTop.classList.add('d-none');
          }
        }
      });
      
      // InfoWindow ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ (initMapã¨addMarkersToMapã®å‰ã«å®šç¾©ãŒå¿…è¦)
      function createInfoWindowContent(location) {
        return `
          <div style="padding: 10px; max-width: 250px; font-family: 'Helvetica Neue', Arial, sans-serif;">
            <h5 style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600;">${location.name}</h5>
            <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
              <strong>ğŸŒ¸ èŠ±:</strong> ${location.flower}
            </p>
            <p style="margin: 4px 0; color: #6b7280; font-size: 14px;">
              <strong>ğŸ“ é›£æ˜“åº¦:</strong> ${location.difficulty || 'æœªè¨­å®š'}
            </p>
            ${location.days_left ? `
              <p style="margin: 4px 0; color: #22c55e; font-size: 14px; font-weight: 600;">
                <strong>â° è¦‹é ƒã¾ã§:</strong> ã‚ã¨${location.days_left}æ—¥
              </p>
            ` : ''}
            <div style="margin-top: 12px;">
              <a href="/flower_mountains/${location.id}" 
                 style="background: linear-gradient(135deg, #22c55e, #16a34a); 
                        color: white; 
                        padding: 6px 12px; 
                        border-radius: 6px; 
                        text-decoration: none; 
                        font-size: 13px; 
                        font-weight: 500;">
                è©³ç´°ã‚’è¦‹ã‚‹
              </a>
            </div>
          </div>
        `;
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ  (initMapã®å‰ã«å®šç¾©ãŒå¿…è¦)
      function addMarkersToMap(locations) {
        // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒãƒƒãƒ—ã‹ã‚‰å‰Šé™¤ã—ã€é…åˆ—ã‚’ã‚¯ãƒªã‚¢
        if (window.HanayamaReminder.markers) { // å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          window.HanayamaReminder.markers.forEach(m => m.marker.setMap(null)); // ä¿®æ­£: m.marker ã«ã‚¢ã‚¯ã‚»ã‚¹
        }
        window.HanayamaReminder.markers = []; // æ–°ã—ã„é…åˆ—ã§åˆæœŸåŒ–
        
        const bounds = new google.maps.LatLngBounds();
        
        locations.forEach(location => {
          if (location.lat && location.lng) {
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(location.lat), lng: parseFloat(location.lng) },
              map: HanayamaReminder.map,
              title: location.name,
              icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                  <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="12" fill="#22c55e" stroke="#fff" stroke-width="2"/>
                    <text x="16" y="20" text-anchor="middle" fill="white" font-size="16">ğŸŒ¸</text>
                  </svg>
                `),
                scaledSize: new google.maps.Size(32, 32)
              }
            });
            
            const infoWindow = new google.maps.InfoWindow({
              content: createInfoWindowContent(location)
            });
            
            marker.addListener('click', () => {
              // ä»–ã®InfoWindowã‚’é–‰ã˜ã‚‹
              HanayamaReminder.markers.forEach(m => {
                if (m.infoWindow) m.infoWindow.close();
              });
              
              infoWindow.open(HanayamaReminder.map, marker);
            });
            // HanayamaReminder.markers ã«ãƒãƒ¼ã‚«ãƒ¼ã¨InfoWindowã‚’ã‚»ãƒƒãƒˆã§ä¿å­˜
            HanayamaReminder.markers.push({ marker: marker, infoWindow: infoWindow });
            bounds.extend(marker.getPosition());
          }
        });
        
        if (HanayamaReminder.markers.length > 0) {
          HanayamaReminder.map.fitBounds(bounds);
          google.maps.event.addListenerOnce(HanayamaReminder.map, 'bounds_changed', () => {
            if (HanayamaReminder.map.getZoom() > 12) {
              HanayamaReminder.map.setZoom(12);
            }
          });
        }
      }

      // åœ°å›³åˆæœŸåŒ–ï¼ˆGoogle Maps APIã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
      window.initMap = function() {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
          // mapè¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆä¾‹ï¼šåœ°å›³ã®ãªã„ãƒšãƒ¼ã‚¸ï¼‰
          // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’ç ´æ£„ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã§ã‚ã‚Œã°ã“ã“ã«è¿½åŠ 
          if (window.HanayamaReminder && window.HanayamaReminder.map) {
            // HanayamaReminder.map.setMap(null); // åœ°å›³è¦ç´ ãŒãªããªã£ãŸã‚‰ãƒãƒƒãƒ—ã‚’ç ´æ£„
            // HanayamaReminder.map = null;
          }
          return;
        }

        // ãƒšãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã³ã«æ–°ã—ã„ãƒãƒƒãƒ—è¦ç´ ãŒç”Ÿæˆã•ã‚Œã‚‹å ´åˆã€æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨ã™ã‚‹ã‹ã€ç ´æ£„ã—ã¦å†ä½œæˆã™ã‚‹
        // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ã€ã‹ã¤æ–°ã—ã„ãƒãƒƒãƒ—è¦ç´ ã«ç´ä»˜ã„ã¦ã„ãªã„å ´åˆã¯ç ´æ£„
        if (window.HanayamaReminder && window.HanayamaReminder.map && 
          window.HanayamaReminder.map.getDiv() !== mapElement) {
          window.HanayamaReminder.map = null; // å¤ã„ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
        }

        // mapãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€ã¾ãŸã¯æ–°ã—ã„mapè¦ç´ ã«åˆæœŸåŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ
        if (!window.HanayamaReminder.map || window.HanayamaReminder.map.getDiv() !== mapElement) {
          const center = { lat: 36.2048, lng: 138.2529 }; 
          window.HanayamaReminder.map = new google.maps.Map(mapElement, {
            zoom: 6,
            center: center,
            styles: [
              {
                featureType: 'all',
                elementType: 'geometry.fill',
                stylers: [{ color: '#f0f9ff' }]
              },
              {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [{ color: '#a7c6ed' }]
              }
            ]
          });
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ ã¯ã€ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«è¡Œã†
        if (window.HanayamaReminder.map && window.mapData && window.mapData.length > 0) {
          addMarkersToMap(window.mapData);
        }
      }; 
      // TurboDriveã®ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã§initMapã‚’å‘¼ã³å‡ºã™
      document.addEventListener('turbo:load', function() {
        // initMapãŒGoogle Maps APIã®callbackã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã‚Šå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
        // ã‚ã‚‹ç¨‹åº¦ã®é…å»¶ã‚’æŒãŸã›ã‚‹ã‹ã€initMapå†…ã§è¤‡æ•°å›ã®åˆæœŸåŒ–ã‚’å®‰å…¨ã«å‡¦ç†ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹
        // ã“ã“ã§ã¯ã€Google Maps APIãŒç¢ºå®Ÿã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
        if (typeof google === 'object' && typeof google.maps === 'object') {
          initMap();
        }
      });
      // ãƒ­ã‚°ã‚¤ãƒ³ä¿ƒé€²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’åˆ¶å¾¡ã™ã‚‹JavaScript (application.jsã«ã¯ç§»å‹•ã•ã›ãªã„)
      document.addEventListener('DOMContentLoaded', () => {
        const loginPromptModal = new bootstrap.Modal(document.getElementById('loginPromptModal'));

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŠ•ç¨¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.btn-gradient-pink').forEach(button => {
          button.addEventListener('click', (event) => {
            const userLoggedIn = event.currentTarget.dataset.userLoggedIn === 'true';
            if (!userLoggedIn) {
              event.preventDefault(); // ãƒªãƒ³ã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’åœæ­¢
              loginPromptModal.show();
            }
            // else {
            //   // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŠ•ç¨¿ç”»é¢ã¸ã®é·ç§»ã‚’è¨±å¯
            //   // ã“ã®ãƒœã‚¿ãƒ³ãŒãƒ•ã‚©ãƒ¼ãƒ ã‚„Ajaxãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æŠ•ç¨¿ã™ã‚‹ã®ã§ã¯ãªãã€
            //   // ç”»é¢é·ç§»ã‚’ç›®çš„ã¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒªãƒ³ã‚¯ã®hrefã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹
            // }
          });
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³)
        document.querySelectorAll('a[href="/users/sign_in"]').forEach(link => {
          link.addEventListener('click', (event) => {
            event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®é·ç§»ã‚’é˜²ã
            loginPromptModal.show(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          });
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œæ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('modalSignUpButton').addEventListener('click', () => {
          window.location.href = '/users/sign_up';
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('modalLoginButton').addEventListener('click', () => {
          window.location.href = '/users/sign_in';
        });
      });
    </script>
  </body>
</html>